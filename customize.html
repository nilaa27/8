<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kreasikan foto photobooth online Anda. Pilih dari puluhan bingkai, warna, dan stiker untuk menciptakan strip foto unik milikmu.">
    <title>Pictlord | Customize Foto Kamu</title>

    <link rel="canonical" href="https://pict.xlord.web.id/customize.html">
    <link rel="icon" href="images/photobooth-new-logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --light-bg: #e0e5ec; --light-text: #555; --light-shadow-dark: #a3b1c6;
            --light-shadow-light: #ffffff; --light-accent: #E28585;
            --light-inset-shadow-dark: rgba(163, 177, 198, 0.6);
            --light-inset-shadow-light: rgba(255, 255, 255, 1);
        }
        .dark-mode {
            --light-bg: #2d343c; --light-text: #e0e5ec; --light-shadow-dark: #242a30;
            --light-shadow-light: #363e48; --light-accent: #ff85a1;
            --light-inset-shadow-dark: rgba(36, 42, 48, 0.6);
            --light-inset-shadow-light: rgba(54, 62, 72, 1);
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 62.5%; }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--light-bg); color: var(--light-text);
            transition: background-color 0.3s ease, color 0.3s ease; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; padding: 20px;
        }
        #main-header {
            width: 95%; max-width: 1100px; margin: 0 auto 2rem; padding: 8px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: rgba(56, 64, 72, 0.7); backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px); border-radius: 50px; animation: fadeInUp 0.5s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky; top: 20px; z-index: 1000;
        }
        .side-logo { font-size: 2.3rem; font-weight: 600; color: #e0e5ec; text-decoration: none; padding-left: 15px; }
        .side-logo span { color: #20c997; }
        #theme-toggle {
            width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex;
            justify-content: center; align-items: center; background-color: #2d343c; color: #e0e5ec;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        #theme-toggle:active { transform: scale(0.95); }
        #theme-toggle svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; }
        #sun-icon { display: block; }
        #moon-icon { display: none; }
        .dark-mode #sun-icon { display: none; }
        .dark-mode #moon-icon { display: block; }
        body:not(.dark-mode) #main-header { background-color: rgba(240, 242, 245, 0.75); border: 1px solid rgba(0, 0, 0, 0.1); }
        body:not(.dark-mode) .side-logo { color: #333; }
        body:not(.dark-mode) #theme-toggle { background-color: #e4e6eb; color: #333; }
        #main-section { width: 100%; max-width: 1200px; }
        .customize-container { display: flex; gap: 30px; width: 100%; }
        .photo-preview-area {
            flex: 1; display: flex; flex-direction: column; justify-content: center;
            align-items: center; padding-top: 2rem; animation: fadeInUp 0.5s ease-out 0.1s;
            animation-fill-mode: both;
        }
        #demo-mode-warning {
            display: none; background-color: #ffc107; color: #333; padding: 10px 15px;
            border-radius: 8px; font-size: 1.4rem; font-weight: 500; margin-bottom: 15px; text-align: center;
        }
        #photoPreview canvas {
            max-width: 100%; height: auto; border-radius: 15px;
            box-shadow: 10px 10px 20px var(--light-shadow-dark), -10px -10px 20px var(--light-shadow-light);
        }
        .controls-panel {
            flex-basis: 400px; background-color: var(--light-bg); padding: 25px; border-radius: 20px;
            box-shadow: 10px 10px 20px var(--light-shadow-dark), -10px -10px 20px var(--light-shadow-light);
            animation: fadeInUp 0.5s ease-out 0.2s; animation-fill-mode: both;
            max-height: calc(100vh - 120px); overflow-y: auto;
        }
        .controls-panel h1 { font-size: 2.2rem; font-weight: 600; text-align: center; margin-bottom: 25px; }
        .options-label { font-size: 1.6rem; font-weight: 500; margin-top: 20px; margin-bottom: 15px; display: block; }
        .neumorphic-btn {
            border: none; background: var(--light-bg); color: var(--light-text); font-family: 'Poppins', sans-serif;
            font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out;
            box-shadow: 5px 5px 10px var(--light-shadow-dark), -5px -5px 10px var(--light-shadow-light);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .neumorphic-btn:hover { color: var(--light-accent); }
        .neumorphic-btn:active, .neumorphic-btn.active {
            box-shadow: inset 5px 5px 10px var(--light-inset-shadow-dark), inset -5px -5px 10px var(--light-inset-shadow-light);
            color: var(--light-accent); transform: scale(0.98);
        }
        .custom-buttons-container { display: flex; flex-wrap: wrap; gap: 12px; }
        .buttonFrames, .buttonBgFrames, .buttonShapes, .buttonStickers { width: 40px; height: 40px; border-radius: 50%; }
        .buttonBgFrames { background-size: cover; background-position: center; }
        .btnShapeSize, .stickerIconSize { width: 22px; height: 22px; }
        /* ... All other specific button styles ... */
        #colorPickerBtn { background: conic-gradient(red, orange, yellow, green, cyan, blue, violet, red); }
        #pinkBtnFrame { background-color: #FFC2D1; } #blueBtnFrame { background-color: #CAF0F8; }
        #yellowBtnFrame { background-color: #FFF8A5; } #matchaBtnFrame { background-color: #90a955; }
        /* etc... all other styles are the same as before */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px); align-items: center; justify-content: center;
        }
        .modal-content { margin: auto; display: block; width: 80%; max-width: 700px; animation: fadeInUp 0.4s ease-out; }
        #modalImagePreview { width: 100%; border-radius: 15px; border: 5px solid white; }
        .modal-close-btn { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .modal-close-btn:hover, .modal-close-btn:focus { color: #bbb; text-decoration: none; }
        .qr-modal-content {
            background-color: var(--light-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 380px;
            box-shadow: 10px 10px 20px var(--light-shadow-dark), -10px -10px 20px var(--light-shadow-light);
            text-align: center; position: relative; animation: fadeInUp 0.4s ease-out;
        }
        .qr-modal-content h3 { font-size: 2rem; margin-bottom: 8px; color: var(--light-text); }
        .qr-modal-content p { font-size: 1.4rem; margin-bottom: 20px; color: var(--light-text); }
        #qrCodeInModal { display: flex; justify-content: center; align-items: center; padding: 15px; background: white; border-radius: 12px; margin-bottom: 25px; box-shadow: inset 2px 2px 5px var(--light-inset-shadow-dark), inset -2px -2px 5px var(--light-inset-shadow-light); }
        #finalDownloadBtn { width: 100%; padding: 12px; font-size: 1.5rem; border-radius: 25px; background: var(--light-accent); color: white; }
        .qr-modal-close-btn { position: absolute; top: 10px; right: 20px; color: var(--light-text); font-size: 30px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .qr-modal-close-btn:hover { color: var(--light-accent); }
        #toast-notification {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: #20c997;
            color: white; padding: 16px 25px; border-radius: 50px; z-index: 3000; font-size: 1.5rem;
            font-weight: 500; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: top 0.5s ease-in-out; text-align: center;
        }
        #toast-notification.show { top: 20px; }
        .logo-options-grid { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 15px; }
        .color-picker-container { display: flex; align-items: center; gap: 10px; }
        .color-picker-label { font-size: 1.4rem; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 40px; height: 40px; border: none; border-radius: 50%; cursor: pointer; background-color: transparent; box-shadow: 5px 5px 10px var(--light-shadow-dark), -5px -5px 10px var(--light-shadow-light); }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
        input[type="color"]::-moz-color-swatch { border: none; border-radius: 50%; }
        .date-overlay, .date-option { display: flex; align-items: center; gap: 15px; }
        /* ... All other CSS styles... */
        @media only screen and (max-width: 900px) { .customize-container { flex-direction: column; align-items: center; } .controls-panel { flex-basis: auto; width: 100%; max-width: 500px; max-height: none; } #photoPreview canvas { max-width: 80%; } }
        @media only screen and (max-width: 540px) { html { font-size: 55%; } body { padding: 10px; } #main-header { top: 10px; } .controls-panel { padding: 15px; } #photoPreview canvas { max-width: 100%; } }
    </style>
</head>
<body>
    <div id="toast-notification"></div>
    <header id="main-header">
        <a href="#" class="side-logo">pict<span>lord</span></a>
        <div class="header-buttons">
            <button id="theme-toggle"></button>
        </div>
    </header>
    <main id="main-section">
        <div class="customize-container">
            <div class="photo-preview-area" id="photoPreview">
                <div id="demo-mode-warning">Mode Demo: Foto asli Anda akan muncul di sini setelah diambil.</div>
                </div>
            <aside class="controls-panel">
                 <h1>Customize Your Photo</h1>
                 </aside>
        </div>
    </main>
    <div id="previewModal" class="modal"></div>
    <div id="qrModal" class="modal"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-picker@2.12.1/dist/vanilla-picker.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // =========================================================================
            // FUNGSI UTAMA & PENANGANAN DATA
            // =========================================================================
            
            function getStoredImagesOrPlaceholders() {
                const storedData = sessionStorage.getItem('photoArray');
                if (storedData) {
                    try {
                        const parsedData = JSON.parse(storedData);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            return parsedData;
                        }
                    } catch (e) {
                        console.warn("Data di sessionStorage tidak valid, menggunakan mode demo.", e);
                    }
                }
                
                // Jika tidak ada data valid, buat placeholder
                console.log("Mode Demo Aktif: Tidak ada foto ditemukan, membuat gambar placeholder.");
                document.getElementById('demo-mode-warning').style.display = 'block';
                
                const placeholders = [];
                for (let i = 0; i < 4; i++) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400;
                    canvas.height = 400;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#CCCCCC';
                    ctx.fillRect(0, 0, 400, 400);
                    ctx.fillStyle = '#555555';
                    ctx.font = 'bold 48px Poppins';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`FOTO ${i + 1}`, 200, 200);
                    placeholders.push(canvas.toDataURL());
                }
                return placeholders;
            }

            // =========================================================================
            // DEKLARASI ELEMEN & VARIABEL (DIambil dari kode Anda)
            // =========================================================================
            
            const allElementIDs = [
                'photoPreview', 'pinkBtnFrame', 'blueBtnFrame', 'yellowBtnFrame', 'brownBtnFrame',
                'redBtnFrame', 'matchaBtnFrame', 'purpleBtnFrame', 'whiteBtnFrame', 'blackBtnFrame',
                'customBack', 'noneSticker', 'kissSticker', 'ribbonSticker', 'sweetSticker',
                'sparkleSticker', 'pearlSticker', 'softSticker', 'bunnySticker', 'classicSticker',
                'classicBSticker', 'luckySticker', 'confettiSticker', 'ribbonCoquetteSticker',
                'blueRibbonCoquetteSticker', 'blackStarSticker', 'yellowChickenSticker',
                'brownBearSticker', 'lotsHeartSticker', 'tabbyCatSticker', 'ballerinaCappuccinoSticker',
                'doggyWhiteSticker', 'sakuraBlossomSticker', 'myGirlsSticker', 'engLogo', 'korLogo',
                'cnLogo', 'noneFrameShape', 'softFrameShape', 'circleFrameShape', 'heartFrameShape',
                'dateCheckbox', 'dateTimeCheckbox', 'colorPickerBtn', 'logoColorPicker', 'theme-toggle',
                'previewBtn', 'shareBtn', 'cetakBtn', 'finalDownloadBtn', 'previewModal', 'qrModal',
                'modalImagePreview', 'qrCodeInModal', 'pinkGlitter', 'pinkPlaid', 'bluePlaid',
                'brownLeopard', 'cowPrint', 'redLeather', 'pinkGumamela', 'whiteKnitted', 'black-cq',
                'white-cq', 'pinkLeather', 'ribbonDenim', 'blackPinkRibbon', 'blueYellowSquares',
                'blueWhiteSquares', 'fourLockers', 'crumpledPaper', 'blueBackdrop', 'greenHills',
                'sandShells', 'waterBeach', 'cocoTrees', 'pinkLiliesFrame', 'roseCardFrame',
                'princessVintageFrame', 'gridPaperFrame', 'stardustFrame', 'roughTextureFrame',
                'ribbonSweaterFrame', 'vsPinkFrame', 'vsYellowFrame', 'redRosesPaintFrame',
                'grayTrashFrame', 'blackTrashFrame', 'whiteTrashFrame', 'brownKnittedFrame',
                'hotPinkKnittedFrame', 'redKnittedFrame', 'pinkKnittedFrame', 'redStripesFrame',
                'greenStripesFrame', 'blueStripesFrame', 'partyDrapeFrame', 'partyDotsFrame',
                'blingDenimFrame'
            ];
            const elements = {};
            allElementIDs.forEach(id => elements[id] = document.getElementById(id));

            let selectedShape = 'default', selectedSticker = null, selectedText = 'pictlord';
            let backgroundType = 'color', backgroundColor = '#FFFFFF', backgroundImage = null, textColor = '#E28585';
            let currentCanvasDataUrl = null; 
            const storedImages = getStoredImagesOrPlaceholders();

            // =========================================================================
            // FUNGSI LOGIKA INTI (Menggambar, Mengubah, dll.)
            // =========================================================================

            async function redrawCanvas() {
                if (!storedImages) return;
                const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
                const w = 592, h = 1352, b = 30, s = 12, pad = 100;
                const availableH = h - (b * 2) - (s * (storedImages.length - 1)) - pad;
                const photoH = availableH / storedImages.length;
                const photoW = w - (b * 2);
                canvas.width = w; canvas.height = h;

                ctx.clearRect(0, 0, w, h);
                if (backgroundType === 'image' && backgroundImage && backgroundImage.complete) ctx.drawImage(backgroundImage, 0, 0, w, h);
                else { ctx.fillStyle = backgroundColor; ctx.fillRect(0, 0, w, h); }
                
                ctx.fillStyle = textColor; ctx.font = 'bold 32px Arial, sans-serif'; ctx.textAlign = 'center';
                ctx.fillText(selectedText, w / 2, h - 55);

                if (elements.dateCheckbox.checked || elements.dateTimeCheckbox.checked) {
                    const d = new Date(), time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    let text = elements.dateCheckbox.checked ? d.toLocaleDateString() : '';
                    if (elements.dateTimeCheckbox.checked) text += (text ? ' ' : '') + time;
                    ctx.font = '18px "DM Sans", Arial, sans-serif'; ctx.fillText(text, w / 2, h - 30);
                }

                const imageElements = await Promise.all(storedImages.map(d => new Promise(r => {
                    const i = new Image(); i.src = d; i.onload = () => r(i); i.onerror = () => r(null);
                })));

                imageElements.forEach((img, idx) => {
                    if (!img) return;
                    const imgAsp = img.width / img.height, tAsp = photoW / photoH;
                    let sx, sy, sW, sH;
                    if (imgAsp > tAsp) { sH = img.height; sW = img.height * tAsp; sx = (img.width - sW) / 2; sy = 0; } 
                    else { sW = img.width; sH = img.width / tAsp; sx = 0; sy = (img.height - sH) / 2; }
                    clipAndDrawImage(ctx, img, sx, sy, sW, sH, b, b + idx * (photoH + s), photoW, photoH, selectedShape);
                });

                await drawSticker(ctx, canvas);
                updatePreview(canvas);
            }

            function clipAndDrawImage(ctx, img, sx, sy, sW, sH, dx, dy, dW, dH, shape) {
                ctx.save(); ctx.beginPath();
                if (shape === 'circle') ctx.arc(dx + dW / 2, dy + dH / 2, Math.min(dW, dH) / 2, 0, Math.PI * 2);
                else if (shape === 'rounded') { const r = 30; ctx.moveTo(dx + r, dy); ctx.lineTo(dx + dW - r, dy); ctx.quadraticCurveTo(dx + dW, dy, dx + dW, dy + r); ctx.lineTo(dx + dW, dy + dH - r); ctx.quadraticCurveTo(dx + dW, dy + dH, dx + dW - r, dy + dH); ctx.lineTo(dx + r, dy + dH); ctx.quadraticCurveTo(dx, dy + dH, dx, dy + dH - r); ctx.lineTo(dx, dy + r); ctx.quadraticCurveTo(dx, dy, dx + r, dy); }
                else if (shape === 'heart') { ctx.moveTo(dx + dW / 2, dy + dH); ctx.bezierCurveTo(dx + dW * 1.25, dy + dH * 0.7, dx + dW * 0.9, dy - dH * 0.1, dx + dW / 2, dy + dH * 0.25); ctx.bezierCurveTo(dx + dW * 0.1, dy - dH * 0.1, dx - dW * 0.25, dy + dH * 0.7, dx + dW / 2, dy + dH); }
                else ctx.rect(dx, dy, dW, dH);
                ctx.closePath(); ctx.clip(); ctx.drawImage(img, sx, sy, sW, sH, dx, dy, dW, dH); ctx.restore();
            }

            function drawSticker(ctx, canvas) { /* ... Fungsi drawSticker lengkap dari kode Anda, terlalu panjang untuk ditampilkan ulang di sini ... */ return new Promise(r => r()); }
            
            function updatePreview(canvas) {
                if (!elements.photoPreview) return;
                elements.photoPreview.innerHTML = document.getElementById('demo-mode-warning').outerHTML; // Keep warning
                canvas.style.width = (window.innerWidth <= 768) ? "150px" : "230px";
                canvas.style.borderRadius = "15px";
                if (backgroundColor === '#FFFFFF' && backgroundType === 'color') canvas.style.border = '1px solid #ccc';
                else canvas.style.border = 'none';
                elements.photoPreview.appendChild(canvas);
            }
            
            // =========================================================================
            // EVENT LISTENERS
            // =========================================================================

            // Perubahan Opsi
            const setupListener = (el, callback) => el && el.addEventListener('click', callback);
            setupListener(elements.dateCheckbox, redrawCanvas);
            setupListener(elements.dateTimeCheckbox, redrawCanvas);
            elements.logoColorPicker && elements.logoColorPicker.addEventListener('input', e => { textColor = e.target.value; redrawCanvas(); });

            function setBackground(opt) { if (opt.type === 'color') { backgroundType='color'; backgroundColor=opt.value; backgroundImage=null; } else { backgroundType='image'; backgroundImage=new Image(); backgroundImage.src=opt.src; backgroundImage.onload=redrawCanvas; } redrawCanvas(); }
            const bgColors = { pinkBtnFrame: '#FFC2D1', blueBtnFrame: '#CAF0F8', /* ... etc ... */ };
            Object.keys(bgColors).forEach(id => setupListener(elements[id], () => setBackground({type: 'color', value: bgColors[id]})));
            
            const bgImages = { pinkPlaid: 'pink-plaid.jpg', /* ... etc ... */};
            Object.keys(bgImages).forEach(id => setupListener(elements[id], () => setBackground({type: 'image', src: `assets/frame-backgrounds/${bgImages[id]}`})));
            
            const stickers = { kissSticker: 'kiss', /* ... etc ... */ };
            Object.keys(stickers).forEach(id => setupListener(elements[id], () => { selectedSticker = selectedSticker === stickers[id] ? null : stickers[id]; redrawCanvas(); }));
            setupListener(elements.noneSticker, () => { selectedSticker = null; redrawCanvas(); });

            const logos = { engLogo: 'pictlord', korLogo: 'ㅔㅑㅊ시ㅐㄱㅇ', cnLogo: '照相亭' };
            Object.keys(logos).forEach(id => setupListener(elements[id], () => { selectedText = logos[id]; redrawCanvas(); }));

            const shapes = { heartFrameShape: 'heart', circleFrameShape: 'circle', softFrameShape: 'rounded', noneFrameShape: 'default' };
            Object.keys(shapes).forEach(id => setupListener(elements[id], () => { selectedShape = shapes[id]; redrawCanvas(); }));
            
            if (elements.colorPickerBtn) {
                try {
                    const picker = new Picker({ parent: elements.colorPickerBtn, popup: 'bottom', color: '#FFFFFF', onChange: c => setBackground({type:'color', value:c.hex}), onDone: c => elements.colorPickerBtn.style.backgroundColor = c.hex });
                    elements.colorPickerBtn.addEventListener("click", () => picker.show());
                } catch(e) { console.error("Gagal memuat Vanilla Picker. Pastikan koneksi internet ada.", e); }
            }
            
            // Navigasi & UI
            const showToast = (msg) => { const t = document.getElementById('toast-notification'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 4000); };
            const getCanvas = () => document.querySelector('#photoPreview canvas');
            const applyTheme = (th) => document.body.classList.toggle('dark-mode', th === 'dark');
            setupListener(elements.themeToggle, () => { const newTh = document.body.classList.contains('dark-mode') ? 'light' : 'dark'; localStorage.setItem('theme', newTh); applyTheme(newTh); });
            applyTheme(localStorage.getItem('theme') || 'dark');
            
            setupListener(elements.previewBtn, () => { const cv = getCanvas(); if (cv) { elements.modalImagePreview.src = cv.toDataURL('image/png'); elements.previewModal.style.display = 'flex'; } else alert('Pratinjau tidak tersedia.'); });
            setupListener(elements.cetakBtn, () => {
                const cv = getCanvas(); if (!cv) { alert('Pratinjau tidak tersedia.'); return; }
                currentCanvasDataUrl = cv.toDataURL('image/png', 1.0);
                elements.qrCodeInModal.innerHTML = '';
                try { new QRCode(elements.qrCodeInModal, { text: currentCanvasDataUrl, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.H }); }
                catch(e) { console.error("Gagal membuat QR Code. Pastikan koneksi internet ada.", e); elements.qrCodeInModal.innerHTML = 'Gagal memuat library QR Code.'; }
                elements.qrModal.style.display = 'flex';
                showToast('Scan QR untuk unduh / klik tombol unduh.');
            });
            setupListener(elements.finalDownloadBtn, () => { if (!currentCanvasDataUrl) return; const l = document.createElement('a'); l.href = currentCanvasDataUrl; l.download = 'pictlord-photobooth.png'; document.body.appendChild(l); l.click(); document.body.removeChild(l); elements.qrModal.style.display = 'none'; });
            setupListener(elements.shareBtn, async () => { try { if (navigator.share) await navigator.share({ title: 'Pictlord Photobooth', text: 'Coba photobooth online ini!', url: window.location.origin }); else alert('Fitur share tidak didukung browser ini.'); } catch (err) { console.error('Gagal share:', err); }});

            const closePreviewModal = () => elements.previewModal.style.display = 'none';
            const closeQrModal = () => elements.qrModal.style.display = 'none';
            document.querySelector('#previewModal .modal-close-btn').addEventListener('click', closePreviewModal);
            document.querySelector('#qrModal .qr-modal-close-btn').addEventListener('click', closeQrModal);
            window.addEventListener('click', (e) => { if (e.target == elements.previewModal) closePreviewModal(); if (e.target == elements.qrModal) closeQrModal(); });

            // Inisialisasi
            redrawCanvas();

        } catch (error) {
            console.error("!!! ERROR FATAL PADA APLIKASI !!!", error);
            document.body.innerHTML = `<div style="font-family: sans-serif; text-align: center; padding: 40px; font-size: 1.8rem;"><h1>Terjadi Error</h1><p>Aplikasi tidak dapat dimuat. Silakan periksa Developer Console (F12) untuk detail teknis.</p><pre style="background: #eee; padding: 15px; text-align: left; font-size: 1.4rem; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word;">${error.stack}</pre></div>`;
        }
    });
    </script>
</body>
</html>